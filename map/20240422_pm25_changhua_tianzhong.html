

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>彰化田中鎮地區空氣汙染pm2.5濃度地圖</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        body {
            background-color: #ccffcc;
            font-family: Arial, sans-serif;
        }
        .header {
            background-color: #006600;
            color: #ffffff;
            padding: 20px;
            text-align: center;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
        }
        #map {
            width: 100vw;
            height: 100vh; /* Adjusted for full viewport height */
        }
        #lineChart {
            width: 100vw;
            height: 60vh; /* Same height for the line chart */
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>彰化田中鎮地區空氣汙染pm2.5濃度地圖</h1>
    </div>
    <div id="map"></div>
    <div id="lineChart"></div>
    <div class="footer">
        Generated by <a href="https://intro.botrun.ai/" target="_blank">Botrun.ai</a>
    </div>
    <script>
        Plotly.d3.csv("https://wengroy.github.io/civilmap/data/20240422_pm25_changhua_tianzhong_24hr.csv", function(err, rows){
            function unpack(rows, key) {
                return rows.map(function(row) { return row[key]; });
            }

            // Map Plot
            var frames = [], sliderSteps = [];
            for (var hour = 0; hour <= 23; hour++) {
                var frameName = `hour${hour}`,
                    frameData = rows.filter(function(row) { return row.hour == hour; }),
                    data = [{
                        type: 'scattermapbox',
                        lat: unpack(frameData, 'lat'),
                        lon: unpack(frameData, 'lon'),
                        mode: 'markers',
                        marker: {
                            size: unpack(frameData, 'value').map(value => value > 54 ? 14 : 10),
                            color: unpack(frameData, 'value').map(value => value > 54 ? 'rgba(255, 0, 0, 0.5)' : 'green')
                        },
                        text: unpack(frameData, 'deviceId').map((deviceId, i) => `DeviceID: ${deviceId}<br>SensorID: ${frameData[i].sensorId}<br>Value: ${frameData[i].value}`),
                        hoverinfo: 'text'
                    }];
                frames.push({name: frameName, data: data});
                sliderSteps.push({
                    method: 'animate',
                    label: hour,
                    args: [[frameName], {mode: 'immediate', frame: {redraw: true, duration: 300}, transition: {duration: 300}}],
                });
            }
            var mapLayout = {
                autosize: true,
                hovermode: 'closest',
                mapbox: {style: 'open-street-map', center: {lat: 23.85, lon: 120.57}, zoom: 12},
                updatemenus: [{
                    x: 0.1,
                    y: 0,
                    yanchor: 'top',
                    xanchor: 'right',
                    showactive: false,
                    direction: 'left',
                    type: 'buttons',
                    pad: {t: 87, r: 10},
                    buttons: [{
                        method: 'animate',
                        args: [null, {fromcurrent: true, frame: {redraw: true, duration: 500}, transition: {duration: 500}}],
                        label: 'Play'
                    }, {
                        method: 'animate',
                        args: [[null], {mode: 'immediate', frame: {redraw: true, duration: 0}}],
                        label: 'Pause'
                    }]
                }],
                sliders: [{
                    pad: {l: 130, t: 55},
                    currentvalue: {
                        visible: true,
                        prefix: 'Hour: ',
                        xanchor: 'right',
                        font: {size: 20, color: '#666'}
                    },
                    steps: sliderSteps
                }]
            };

            // Line Chart Plot
            var deviceIdUniq = [...new Set(rows.map(row => row.deviceId))];
            var lineData = deviceIdUniq.map(function(id) {
                var deviceData = rows.filter(row => row.deviceId === id);
                return {
                    type: 'scatter',
                    mode: 'lines',
                    x: unpack(deviceData, 'hour'),
                    y: unpack(deviceData, 'value'),
                    name: `Device ${id}`
                };
            });
            var lineLayout = {title: 'PM2.5 Values Over Time by Device', xaxis: {title: 'Hour'}, yaxis: {title: 'PM2.5 Value'}};

            Plotly.newPlot('map', frames[0].data, mapLayout).then(function() {
                Plotly.addFrames('map', frames);
            });
            Plotly.newPlot('lineChart', lineData, lineLayout);
        });
    </script>
</body>
</html>


